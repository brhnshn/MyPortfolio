name: Deploy to VDS

on:
  push:
    branches:
      - master # Eger branch ismin master ise burayi master olarak degistir

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Projeyi Ã‡ek (Checkout)
      uses: actions/checkout@v3

    - name: âš™ï¸ .NET Kurulumu
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: ðŸ” Åžifreleri (Secrets) AppSettings Ä°Ã§ine Enjekte Et
      uses: microsoft/variable-substitution@v1
      with:
        files: 'MyPortfolio/appsettings.json'
      env:
        ConnectionStrings.DefaultConnection: "Host=db.qxsbrqewndxqmdxozhea.supabase.co;Database=postgres;Username=postgres;Password=${{ secrets.DB_PASSWORD }};SSL Mode=Require;Trust Server Certificate=true;Pooling=true;Maximum Pool Size=20;"
        SmtpSettings.Password: "${{ secrets.SMTP_PASSWORD }}"
        SetupSettings.Key: "${{ secrets.SETUP_KEY }}"

    - name: ðŸ”¨ Projeyi Derle (Publish) ve ZIP'le
      run: |
        cd MyPortfolio
        dotnet publish -c Release -r linux-x64 --self-contained false -o ../publish_output
        cd ../publish_output
        zip -r ../MyPortfolio.zip ./*

    - name: ðŸš€ ZIP DosyasÄ±nÄ± VDS'e Aktar (SCP)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VDS_HOST }}
        username: ${{ secrets.VDS_USERNAME }}
        password: ${{ secrets.VDS_PASSWORD }}
        port: ${{ secrets.VDS_PORT }}
        source: "MyPortfolio.zip"
        target: "/var/www" 

    - name: ðŸ”„ VDS Ãœzerinde Unzip Et ve Sistemi Yeniden BaÅŸlat (SSH)
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.VDS_HOST }}
        username: ${{ secrets.VDS_USERNAME }}
        password: ${{ secrets.VDS_PASSWORD }}
        port: ${{ secrets.VDS_PORT }}
        script: |
          echo "1. Hedef klasore gidiliyor..."
          cd /var/www

          echo "2. Yeni Zip dosyasi cikartiliyor ve ustune yaziliyor..."
          unzip -o MyPortfolio.zip -d /var/www/MyPortfolio

          echo "3. Cikartilan Zip dosyasi siliniyor..."
          rm -f MyPortfolio.zip

          echo "4. Servisler Yeniden Baslatiliyor..."
          SCRIPT_PATH=$(find / -type f -name "project-manager.sh" 2>/dev/null | head -n 1)
          if [ -n "$SCRIPT_PATH" ]; then
            echo "Script bulundu: $SCRIPT_PATH"
            bash -i -c "source ~/.bashrc 2>/dev/null || true; source ~/.profile 2>/dev/null || true; cd /var/www/ && bash '$SCRIPT_PATH' restart"
          else
            echo "HATA: project-manager.sh dinamik olarak bulunamadi, global terminal emri ile deneniyor..."
            bash -i -c "source ~/.bashrc 2>/dev/null || true; source ~/.profile 2>/dev/null || true; cd /var/www/ && project-manager.sh restart"
          fi
          
          echo "TÃ¼m islemler basariyla tamamlandi!"
