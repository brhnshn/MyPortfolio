name: Deploy to VDS

on:
  push:
    branches:
      - master # Eger branch ismin master ise burayi master olarak degistir

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Projeyi Ã‡ek (Checkout)
      uses: actions/checkout@v3

    - name: âš™ï¸ .NET Kurulumu
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: ðŸ” Åžifreleri (Secrets) AppSettings Ä°Ã§ine Enjekte Et
      uses: microsoft/variable-substitution@v1
      with:
        files: 'MyPortfolio/appsettings.json'
      env:
        ConnectionStrings.DefaultConnection: "User Id=postgres.qxsbrqewndxqmdxozhea;Password=${{ secrets.DB_PASSWORD }};Server=aws-1-eu-central-1.pooler.supabase.com;Port=5432;Database=postgres"
        SmtpSettings.Password: "${{ secrets.SMTP_PASSWORD }}"

    - name: ðŸ”¨ Projeyi Derle (Publish)
      run: |
        cd MyPortfolio
        dotnet publish -c Release -r linux-x64 --self-contained false -o ../publish_output

    - name: ðŸš€ Publish EdilmiÅŸ DosyalarÄ± VDS'e Aktar (SCP)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VDS_HOST }}
        username: ${{ secrets.VDS_USERNAME }}
        password: ${{ secrets.VDS_PASSWORD }}
        port: ${{ secrets.VDS_PORT }}
        source: "publish_output/*"
        target: "/var/www/MyPortfolio" 
        strip_components: 1 # DosyalarÄ± /publish_output/ kalabalÄ±gÄ± olmadan aktarÄ±r
        rm: false # project-manager.sh gibi ozel dosyalari silmemesi icin false yapildi

    - name: ðŸ”„ VDS Ãœzerinde Eski KalÄ±ntÄ±larÄ± Sil ve Sistemi Yeniden BaÅŸlat (SSH)
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.VDS_HOST }}
        username: ${{ secrets.VDS_USERNAME }}
        password: ${{ secrets.VDS_PASSWORD }}
        port: ${{ secrets.VDS_PORT }}
        script: |
          echo "1. Hedef klasore gidiliyor..."
          cd /var/www/MyPortfolio

          echo "2. Artik ihtiyac kalmayan eski ZIP (varsa) son kez siliniyor..."
          rm -f MyPortfolio.zip
          rm -f *.zip

          echo "3. Servisler Yeniden Baslatiliyor..."
          SCRIPT_PATH=$(find / -type f -name "project-manager.sh" 2>/dev/null | head -n 1)
          if [ -n "$SCRIPT_PATH" ]; then
            echo "Script bulundu: $SCRIPT_PATH"
            cd /var/www/
            bash "$SCRIPT_PATH" restart
          else
            echo "HATA: project-manager.sh bulunamadi!"
            exit 1
          fi
          
          echo "TÃ¼m islemler basariyla tamamlandi!"
