name: Deploy to VDS

on:
  push:
    branches:
      - master # Eger branch ismin master ise burayi master olarak degistir

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Projeyi Ã‡ek (Checkout)
      uses: actions/checkout@v3

    - name: âš™ï¸ .NET Kurulumu
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: ğŸ” Åifreleri (Secrets) AppSettings Ä°Ã§ine Enjekte Et
      run: |
        sed -i "s|__DB_PASSWORD__|${{ secrets.DB_PASSWORD }}|g" MyPortfolio/appsettings.json
        sed -i "s|__SMTP_PASSWORD__|${{ secrets.SMTP_PASSWORD }}|g" MyPortfolio/appsettings.json

    - name: ğŸ”¨ Projeyi Derle (Publish)
      run: |
        cd MyPortfolio
        dotnet publish -c Release -r linux-x64 --self-contained false -o ../publish_output

    - name: ğŸš€ Publish EdilmiÅŸ DosyalarÄ± VDS'e Aktar (SCP)
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VDS_HOST }}
        username: ${{ secrets.VDS_USERNAME }}
        password: ${{ secrets.VDS_PASSWORD }}
        port: ${{ secrets.VDS_PORT }}
        source: "publish_output/*"
        target: "/var/www/MyPortfolio" 
        strip_components: 1 # DosyalarÄ± /publish_output/ kalabalÄ±gÄ± olmadan aktarÄ±r
        rm: true # YÃ¼klemeden Ã¶nce hedef klasÃ¶rdeki eski (.dll vb.) dosyalarÄ± tertemiz siler

    - name: ğŸ”„ VDS Ãœzerinde Eski KalÄ±ntÄ±larÄ± Sil ve Sistemi Yeniden BaÅŸlat (SSH)
      uses: appleboy/ssh-action@v0.1.6
      with:
        host: ${{ secrets.VDS_HOST }}
        username: ${{ secrets.VDS_USERNAME }}
        password: ${{ secrets.VDS_PASSWORD }}
        port: ${{ secrets.VDS_PORT }}
        script: |
          echo "1. Hedef klasore gidiliyor..."
          cd /var/www

          echo "2. Artik ihtiyac kalmayan eski ZIP (varsa) son kez siliniyor..."
          rm -f MyPortfolio.zip
          rm -f *.zip

          echo "3. Servisler Yeniden Baslatiliyor..."
          ./project-manager.sh restart
          
          echo "TÃ¼m islemler basariyla tamamlandi!"
